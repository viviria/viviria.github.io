window.__require=function e(t,i,n){function o(s,r){if(!i[s]){if(!t[s]){var c=s.split("/");if(c=c[c.length-1],!t[c]){var h="function"==typeof __require&&__require;if(!r&&h)return h(c,!0);if(a)return a(c,!0);throw new Error("Cannot find module '"+s+"'")}}var l=i[s]={exports:{}};t[s][0].call(l.exports,function(e){return o(t[s][1][e]||e)},l,l.exports,e,t,i,n)}return i[s].exports}for(var a="function"==typeof __require&&__require,s=0;s<n.length;s++)o(n[s]);return o}({main:[function(e,t,i){"use strict";cc._RF.push(t,"13201ArYMZBvLvxXK160b4h","main");var n=cc.Enum({FLOOR:0,WALL:1,ITEM:2,ENEMY:3,STAIRS:4});cc.Class({extends:cc.Component,properties:{floorPrefab:{type:cc.Prefab,default:null},wallPrefab:{type:cc.Prefab,default:null},enemyPrefab:{type:cc.Prefab,default:null},itemPrefab:{type:cc.Prefab,default:null},stairsPrefab:{type:cc.Prefab,default:null},_isTouch:!1,_fileName:"map"},setStateLabel:function(e){this.node.getChildByName("stateLabel").getComponent(cc.Label).string=e},onTapChangeMoveMode:function(){var e=this;this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("move"),this.node.getChildByName("positionResetButton").active=!0;var t=null,i=this.node.getChildByName("map");this.node.on(cc.Node.EventType.TOUCH_START,function(i){e._isTouch=!0,t=i.getLocation()},this),this.node.on(cc.Node.EventType.TOUCH_MOVE,function(n){if(e._isTouch&&t){var o=n.getLocation();i.position=i.position.add(o.sub(t)),t=o}},this);var n=function(i){e._isTouch=!1,t=null,e.save()};this.node.on(cc.Node.EventType.TOUCH_END,n,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,n,this)},onTapMoveReset:function(){this.node.targetOff(this),this.subUIDisabled(),this.node.getChildByName("map").position=cc.v2(0,0)},getNearlyPosition:function(e,t){var i=e.x%t,n=e.y%t,o=(Math.trunc(e.x/t)+(i>=t/2?1:i<-t/2?-1:0))*t,a=(Math.trunc(e.y/t)+(n>=t/2?1:n<-t/2?-1:0))*t;return new cc.Vec2(o,a)},isAlreadyPutObject:function(e,t){for(var i=this.node.getChildByName("map").getChildren().filter(function(e){return e.type==t}),n=0;n<i.length;n++)if(i[n].x==e.x&&i[n].y==e.y)return!0;return!1},generateFloor:function(e){var t=this.node.getChildByName("map"),i=this.getNearlyPosition(t.convertToNodeSpace(e),50);if(!this.isAlreadyPutObject(i,n.FLOOR)){var o=cc.instantiate(this.floorPrefab);o.type=n.FLOOR,o.position=i,t.addChild(o)}},onTapChangeFloorMode:function(){var e=this;this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("floor"),this.node.on(cc.Node.EventType.TOUCH_START,function(t){e._isTouch=!0,e.generateFloor(t.getLocation())},this),this.node.on(cc.Node.EventType.TOUCH_MOVE,function(t){e._isTouch&&e.generateFloor(t.getLocation())},this);var t=function(t){e._isTouch=!1,e.save()};this.node.on(cc.Node.EventType.TOUCH_END,t,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,t,this)},getfloor:function(e){for(var t=this.node.getChildByName("map").getChildren().filter(function(e){return e.type==n.FLOOR}),i=0;i<t.length;i++)if(t[i].x==e.x&&t[i].y==e.y)return t[i];return null},getWallPositionAndAngle:function(e,t){var i=180*Math.atan2(e.x-t.x,e.y-t.y)/Math.PI,n=cc.v2(0,0),o=0;return i>-45&&i<=45?(n=cc.v2(0,25),o=0):i>45&&i<=135?(n=cc.v2(25,0),o=-90):i>-135&&i<=-45?(n=cc.v2(-25,0),o=90):(n=cc.v2(0,-25),o=180),{position:t.add(n),angle:o}},generateWall:function(e){var t=this.node.getChildByName("map"),i=t.convertToNodeSpace(e),o=this.getNearlyPosition(i,50);if(this.getfloor(o)){var a=this.getWallPositionAndAngle(i,o);if(!this.isAlreadyPutObject(a.position,n.WALL)){var s=cc.instantiate(this.wallPrefab);s.type=n.WALL,s.position=a.position,s.angle=a.angle,t.addChild(s)}}},onTapChangeWallMode:function(){var e=this;this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("wall"),this.node.on(cc.Node.EventType.TOUCH_START,function(t){e._isTouch=!0,e.generateWall(t.getLocation())},this),this.node.on(cc.Node.EventType.TOUCH_MOVE,function(t){e._isTouch&&e.generateWall(t.getLocation())},this);var t=function(t){e._isTouch=!1,e.save()};this.node.on(cc.Node.EventType.TOUCH_END,t,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,t,this)},isAlreadyPutEnemy:function(e){return e.getChildren().filter(function(e){return e.type==n.ENEMY}).length>0},generateEnemy:function(e){var t=this.node.getChildByName("map").convertToNodeSpace(e),i=this.getNearlyPosition(t,50),o=this.getfloor(i);if(o&&!this.isAlreadyPutEnemy(o)&&!this.isAlreadyPutStairs(o)){var a=cc.instantiate(this.enemyPrefab);a.type=n.ENEMY,a.position=cc.v2(0,0),this.isAlreadyPutItem(o)&&a.setContentSize(10,10),o.addChild(a)}},onTapChangeEnemyMode:function(){var e=this;this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("enemy"),this.node.on(cc.Node.EventType.TOUCH_START,function(t){e._isTouch=!0,e.generateEnemy(t.getLocation())},this);var t=function(t){e._isTouch=!1,e.save()};this.node.on(cc.Node.EventType.TOUCH_END,t,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,t,this)},isAlreadyPutItem:function(e){return e.getChildren().filter(function(e){return e.type==n.ITEM}).length>0},generateItem:function(e){var t=this.node.getChildByName("map").convertToNodeSpace(e),i=this.getNearlyPosition(t,50),o=this.getfloor(i);if(o&&!this.isAlreadyPutItem(o)&&!this.isAlreadyPutStairs(o)){var a=cc.instantiate(this.itemPrefab);a.type=n.ITEM,a.position=cc.v2(0,0),this.isAlreadyPutEnemy(o)&&a.setContentSize(10,10),o.addChild(a)}},onTapChangeItemMode:function(){var e=this;this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("item"),this.node.on(cc.Node.EventType.TOUCH_START,function(t){e._isTouch=!0,e.generateItem(t.getLocation())},this);var t=function(t){e._isTouch=!1,e.save()};this.node.on(cc.Node.EventType.TOUCH_END,t,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,t,this)},isAlreadyPutStairs:function(e){return e.getChildren().filter(function(e){return e.type==n.STAIRS}).length>0},generateStairs:function(e){var t=this.node.getChildByName("map").convertToNodeSpace(e),i=this.getNearlyPosition(t,50),o=this.getfloor(i);if(o&&!(this.isAlreadyPutStairs(o)||this.isAlreadyPutItem(o)||this.isAlreadyPutEnemy(o))){var a=cc.instantiate(this.stairsPrefab);a.type=n.STAIRS,a.position=cc.v2(0,0),o.addChild(a)}},onTapChangeStairsMode:function(){var e=this;this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("stairs"),this.node.on(cc.Node.EventType.TOUCH_START,function(t){e.generateStairs(t.getLocation())},this);var t=function(t){e._isTouch=!1,e.save()};this.node.on(cc.Node.EventType.TOUCH_END,t,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,t,this)},convertJson:function(){var e=this.node.getChildByName("map").getChildren().map(function e(t){return{type:t.type,position:t.position,angle:t.angle,children:t.getChildren().map(e)}});return JSON.stringify(e)},onTapDownload:function(){this.save();var e=this.convertJson();Base64&&RawDeflate&&(e=Base64.toBase64(RawDeflate.deflate(Base64.utob(e))),console.log(e));var t=this.node.getChildByName("saveWindow");t.active=!0,t.getComponent(cc.WebView).url="https://viviria.github.io/JsonDownloader/?name="+this._fileName+"&data="+e},subUIDisabled:function(){this.node.getChildByName("saveWindow").active=!1,this.node.getChildByName("positionResetButton").active=!1},getHitWall:function(e){for(var t=this.node.getChildByName("map").getChildren().filter(function(e){return e.type==n.WALL}),i=0;i<t.length;i++){var o=t[i].getComponent(cc.BoxCollider).world.points;if(cc.Intersection.pointInPolygon(e,o))return t[i]}return null},removeObject:function(e){var t=this.getHitWall(e);if(t)t.removeFromParent();else{var i=this.node.getChildByName("map").convertToNodeSpace(e),n=this.getNearlyPosition(i,50),o=this.getfloor(n);if(o){var a=o.getChildren().reverse();if(a.length>0)return a[0].removeFromParent(),void this.save();o.removeFromParent(),this.save()}}},onTapChangeRemoveMode:function(){var e=this;this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("remove"),this.node.on(cc.Node.EventType.TOUCH_START,function(t){e.removeObject(t.getLocation())},this)},save:function(){cc.sys.localStorage.setItem(this._fileName,this.convertJson())},getPrefabByType:function(e){switch(e){case n.FLOOR:return this.floorPrefab;case n.WALL:return this.wallPrefab;case n.ENEMY:return this.enemyPrefab;case n.ITEM:return this.itemPrefab;case n.STAIRS:return this.stairsPrefab}return null},convertMap:function(e){var t=this,i=function(e,t){for(var i=0;i<t.length;i++)e.addChild(t[i])},n=this.node.getChildByName("map"),o=JSON.parse(e).map(function e(n){var o=t.getPrefabByType(n.type),a=cc.instantiate(o);a.type=n.type,a.position=n.position,a.angle=n.angle;var s=n.children.map(e);return i(a,s),a});i(n,o)},onTapStartOk:function(){var e=this.node.getChildByName("startMenu"),t=e.getChildByName("editBox").getComponent(cc.EditBox);if(this._fileName=t.string,this._fileName){var i=cc.sys.localStorage.getItem(this._fileName);i&&this.convertMap(i)}e.active=!1,this.node.getChildByName("ui").active=!0},onLoad:function(){cc.director.getCollisionManager().enabled=!0},start:function(){this._isTouch=!1},update:function(e){}}),cc._RF.pop()},{}]},{},["main"]);