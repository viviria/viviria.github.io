window.__require=function e(t,i,n){function a(c,s){if(!i[c]){if(!t[c]){var r=c.split("/");if(r=r[r.length-1],!t[r]){var l="function"==typeof __require&&__require;if(!s&&l)return l(r,!0);if(o)return o(r,!0);throw new Error("Cannot find module '"+c+"'")}}var h=i[c]={exports:{}};t[c][0].call(h.exports,function(e){return a(t[c][1][e]||e)},h,h.exports,e,t,i,n)}return i[c].exports}for(var o="function"==typeof __require&&__require,c=0;c<n.length;c++)a(n[c]);return a}({main:[function(e,t,i){"use strict";cc._RF.push(t,"13201ArYMZBvLvxXK160b4h","main");var n=cc.Enum({FLOOR:0,WALL:1,WATER:2,NUM:3}),a=cc.Enum({ENEMY:0,ITEM:1,STAIRS:2,TRAP:3}),o=cc.Enum({NONE:0,MOVE:1,TILE:2,ENEMY:3,ITEM:4,STAIRS:5,TRAP:6}),c=function(){return cc.game.config.debugMode<=1};cc.Class({extends:cc.Component,properties:{floorPrefab:{type:cc.Prefab,default:null},wallPrefab:{type:cc.Prefab,default:null},waterPrefab:{type:cc.Prefab,default:null},enemyPrefab:{type:cc.Prefab,default:null},itemPrefab:{type:cc.Prefab,default:null},stairsPrefab:{type:cc.Prefab,default:null},trapPrefab:{type:cc.Prefab,default:null},detailPanelPrefab:{type:cc.Prefab,default:null},tileTypePanelPrefab:{type:cc.Prefab,default:null},_isTouch:!1,_fileName:"map",_cannotAction:!1,_mode:o.NONE,_tileType:n.FLOOR},setStateLabel:function(e){this.node.getChildByName("stateLabel").getComponent(cc.Label).string=e},changeMode:function(e,t,i){var n=this;if(!this._cannotAction){this.node.targetOff(this),this.subUIDisabled(),this.node.on(cc.Node.EventType.TOUCH_START,function(t){n._cannotAction||(n._isTouch=!0,e&&e(t.getLocation()))},this),this.node.on(cc.Node.EventType.TOUCH_MOVE,function(e){n._isTouch&&t&&t(e.getLocation())},this);var a=function(e){n._isTouch&&i&&i(),n._isTouch=!1};this.node.on(cc.Node.EventType.TOUCH_END,a,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,a,this)}},onTapChangeMode:function(e,t){switch(this._mode=Number(t),this._mode){case o.MOVE:this.setStateLabel("move"),this.changeMoveMode();break;case o.TILE:this.setStateLabel("tile"),this.changeTileMode();break;case o.ENEMY:this.setStateLabel("enemy"),this.changeEventObjectMode(a.ENEMY);break;case o.ITEM:this.setStateLabel("item"),this.changeEventObjectMode(a.ITEM);break;case o.STAIRS:this.setStateLabel("stairs"),this.changeEventObjectMode(a.STAIRS);break;case o.TRAP:this.setStateLabel("trap"),this.changeEventObjectMode(a.TRAP)}},changeMoveMode:function(){var e=this.node.getChildByName("map"),t=null;this.changeMode(function(e){t=e},function(i){var n=i;e.position=e.position.add(n.sub(t)),t=n},function(){t=null}),this.node.getChildByName("positionResetButton").active=!0},changeTileMode:function(){var e=this;this.changeMode(function(t){e.generateTile(t,e._tileType)},function(t){e.generateTile(t,e._tileType)},function(){e.save()}),this.createTileTypeView()},getTileTypeName:function(e){switch(e){case n.FLOOR:return"floor";case n.WALL:return"wall";case n.WATER:return"water"}return""},onTapSetTileType:function(e,t){var i=Number(t);this._tileType=i},instantiateTileTypePanel:function(e){var t=cc.instantiate(this.tileTypePanelPrefab);t.getChildByName("typeLabel").getComponent(cc.Label).string="type: "+e,t.getChildByName("name").getComponent(cc.Label).string=this.getTileTypeName(e);var i=this.instantiateTile(e);i.position=cc.v2(0,0),t.getChildByName("type").addChild(i);var n=t.getComponent(cc.Button),a=new cc.Component.EventHandler;return a.target=this.node,a.customEventData=e,a.handler="onTapSetTileType",a.component=this.node.parent.name,n.clickEvents.push(a),t},createTileTypeView:function(){var e=this.node.getChildByName("tileTypeView");e.active=!0;var t=e.getComponent(cc.ScrollView).content;t.removeAllChildren();for(var i=0,a=0;a<n.NUM;a++){var o=this.instantiateTileTypePanel(a),c=o.height+10;i+=c,o.position=cc.v2(0,-a*c-20),t.addChild(o)}t.height=i+40},changeEventObjectMode:function(e){var t=this;this.changeMode(function(i){switch(e){case a.ENEMY:t.generateEventObject(i,a.ENEMY,[a.ENEMY],[a.ITEM,a.STAIRS,a.TRAP]);break;case a.ITEM:t.generateEventObject(i,a.ITEM,[a.ITEM,a.STAIRS],[a.ENEMY,a.TRAP]);break;case a.STAIRS:t.generateEventObject(i,a.STAIRS,[a.STAIRS,a.ITEM,a.TRAP],[a.ENEMY]);break;case a.TRAP:t.generateEventObject(i,a.TRAP,[a.TRAP,a.STAIRS],[a.ENEMY,a.ITEM])}})},onTapMoveReset:function(){this.node.targetOff(this),this.subUIDisabled(),this.node.getChildByName("map").position=cc.v2(0,0)},getNearlyPosition:function(e,t){var i=e.x%t,n=e.y%t,a=(Math.trunc(e.x/t)+(i>=t/2?1:i<-t/2?-1:0))*t,o=(Math.trunc(e.y/t)+(n>=t/2?1:n<-t/2?-1:0))*t;return new cc.Vec2(a,o)},isAlreadyPutTile:function(e){for(var t=this.node.getChildByName("map").getChildren(),i=0;i<t.length;i++)if(t[i].x==e.x&&t[i].y==e.y)return!0;return!1},instantiateTile:function(e){switch(e){case n.FLOOR:return cc.instantiate(this.floorPrefab);case n.WALL:return cc.instantiate(this.wallPrefab);case n.WATER:return cc.instantiate(this.waterPrefab)}return null},generateTile:function(e,t){var i=this.node.getChildByName("map"),n=this.getNearlyPosition(i.convertToNodeSpace(e),50);if(!this.isAlreadyPutTile(n)){var a=this.instantiateTile(t);a.interId=t,a.type=t,a.position=n,i.addChild(a)}},getTile:function(e){for(var t=this.node.getChildByName("map").getChildren(),i=0;i<t.length;i++)if(t[i].x==e.x&&t[i].y==e.y)return t[i];return null},isAlreadyPutTypeOnTile:function(e,t){return e.getChildren().filter(function(e){return t.indexOf(e.type)>=0}).length>0},instantiateEventObject:function(e){switch(e){case a.ITEM:return cc.instantiate(this.itemPrefab);case a.ENEMY:return cc.instantiate(this.enemyPrefab);case a.STAIRS:return cc.instantiate(this.stairsPrefab);case a.TRAP:return cc.instantiate(this.trapPrefab)}return null},generateEventObject:function(e,t,i,a){var o=this.node.getChildByName("map").convertToNodeSpace(e),c=this.getNearlyPosition(o,50),s=this.getTile(c);if(s&&s.type!=n.WALL&&!this.isAlreadyPutTypeOnTile(s,i)){var r=this.instantiateEventObject(t);r.type=t,r.position=cc.v2(0,0),this.isAlreadyPutTypeOnTile(s,a)&&r.setContentSize(10,10),s.addChild(r),this.showDetailView(s)}},convertJson:function(){var e=this.node.getChildByName("map").getChildren().map(function e(t){return{id:t.interId,type:t.type,position:t.position,children:t.getChildren().map(e)}});return JSON.stringify(e)},onTapDownload:function(){if(!this._cannotAction){this.save();var e=this.convertJson();c()||(e=Base64.toBase64(RawDeflate.deflate(Base64.utob(e))));var t=this.node.getChildByName("saveWindow");t.active=!0,t.getComponent(cc.WebView).url="https://viviria.github.io/JsonDownloader/?name="+this._fileName+"&data="+e}},subUIDisabled:function(){this.node.getChildByName("saveWindow").active=!1,this.node.getChildByName("positionResetButton").active=!1,this.node.getChildByName("tileTypeView").active=!1,this.closeDetailView()},removeObject:function(e){var t=this.node.getChildByName("map").convertToNodeSpace(e),i=this.getNearlyPosition(t,50),n=this.getTile(i);if(n){var a=n.getChildren().reverse();if(a.length>0)return a[0].removeFromParent(),void this.save();n.removeFromParent(),this.save()}},onTapChangeRemoveMode:function(){var e=this;this._cannotAction||(this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("remove"),this.node.on(cc.Node.EventType.TOUCH_START,function(t){e._cannotAction||e.removeObject(t.getLocation())},this))},showDetailTile:function(e){var t=this.node.getChildByName("map").convertToNodeSpace(e),i=this.getNearlyPosition(t,50),n=this.getTile(i);n&&this.showDetailView(n,!1)},onTapChangeDetailMode:function(){var e=this;this._cannotAction||(this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("detail"),this.node.on(cc.Node.EventType.TOUCH_START,function(t){e._cannotAction||e.showDetailTile(t.getLocation())},this))},save:function(){var e=this.convertJson();e&&"[]"!=e&&(c()||(e=Base64.toBase64(RawDeflate.deflate(Base64.utob(e)))),cc.sys.localStorage.setItem(this._fileName,e))},convertMap:function(e){var t=this,i=function(e,t){for(var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=0;n<t.length;n++)if(e.addChild(t[n]),i){var a=t[n].getContentSize();t[n].setContentSize(a.width*Math.pow(.5,n),a.height*Math.pow(.5,n))}},n=function(e,t){e.interId=t.id,e.type=t.type,e.position=t.position},a=function e(a){var o=t.instantiateEventObject(a.type);n(o,a);var c=a.children.map(e);return i(o,c,!0),o},o=this.node.getChildByName("map"),s=e;if(c()||(s=Base64.btou(RawDeflate.inflate(Base64.fromBase64(s)))),s&&"[]"!=s){var r=JSON.parse(s).map(function(e){var o=t.instantiateTile(e.type);n(o,e);var c=e.children.map(a);return i(o,c,!0),o});i(o,r)}},onTapStartOk:function(){var e=this.node.getChildByName("startMenu"),t=e.getChildByName("editBox").getComponent(cc.EditBox);if(this._fileName=t.string||"map",this._fileName){var i=cc.sys.localStorage.getItem(this._fileName);i&&this.convertMap(i)}e.active=!1;var n=this.node.getChildByName("ui");n.active=!0,n.getChildByName("mapNameLabel").getComponent(cc.Label).string=this._fileName},setUIButtonEnabled:function(e){for(var t=this.node.getChildByName("ui").getChildren(),i=0;i<t.length;i++){var n=t[i].getComponent(cc.Button);n&&(n.interactable=e)}},createDetailPanel:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=cc.instantiate(this.detailPanelPrefab),n=t?this.instantiateTile(e.type):this.instantiateEventObject(e.type);n.position=cc.v2(0,0),i.getChildByName("symbol").addChild(n),i.getChildByName("nameLabel").getComponent(cc.Label).string=n.name,i.targetNode=e,i.isTile=t;var a=i.getChildByName(t?"type":"id");return a.getChildByName("editBox").getComponent(cc.EditBox).string=void 0===e.interId?-1:e.interId,a.active=!0,i},showDetailView:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=e.getChildren(),n=this.node.getChildByName("mark");n.active=!0,n.position=e.position.add(e.parent.position);var a=this.node.getChildByName("detailView");a.active=!0;var o=a.getComponent(cc.ScrollView).content;o.removeAllChildren();var c=this.createDetailPanel(e,!0);c.position=cc.v2(0,-20),o.addChild(c);for(var s=0;s<i.length;s++)(c=this.createDetailPanel(i[s])).position=cc.v2(0,-(s+1)*(c.height+10)-20),o.addChild(c);t&&(this.node.getChildByName("viewBackground").active=!0,this.setUIButtonEnabled(!1),this._cannotAction=!0)},onTapSaveDetail:function(){for(var e=this,t=this.node.getChildByName("detailView").getComponent(cc.ScrollView).content.getChildren(),i=function(t,i){var n=e.instantiateTile(i);if(n){for(var a=t.getChildren(),o=a.length,c=0;c<o;c++){var s=a[0];s.removeFromParent(),n.addChild(s)}n.interId=n.type=i,n.position=t.position,t.removeFromParent(),e.node.getChildByName("map").addChild(n)}},n=0;n<t.length;n++){var a=t[n],o=a.getChildByName(a.isTile?"type":"id").getChildByName("editBox");if(isNaN(o.getComponent(cc.EditBox).string))return}for(var c=0;c<t.length;c++){var s=t[c];if(s.isTile){var r=s.getChildByName("type").getChildByName("editBox"),l=Number(r.getComponent(cc.EditBox).string);i(s.targetNode,l)}else{var h=s.getChildByName("id").getChildByName("editBox");s.targetNode.interId=Number(h.getComponent(cc.EditBox).string)}}this.save(),this.closeDetailView()},closeDetailView:function(){this.node.getChildByName("detailView").active=!1,this.node.getChildByName("mark").active=!1,this._cannotAction&&(this._cannotAction=!1,this.setUIButtonEnabled(!0),this.node.getChildByName("viewBackground").active=!1)},onTapSpecialView:function(){var e=this.node.getChildByName("specialView");this.setUIButtonEnabled(!1),this.node.getChildByName("viewBackground").active=!0,e.active=!0,this._cannotAction=!0},onTapCloseSpecialView:function(){var e=this.node.getChildByName("specialView");this.setUIButtonEnabled(!0),this.node.getChildByName("viewBackground").active=!1,e.active=!1,this._cannotAction=!1},onTapRemoveMap:function(){cc.sys.localStorage.removeItem(this._fileName),this.node.getChildByName("map").removeAllChildren(),this.onTapCloseSpecialView()},onLoad:function(){cc.director.getCollisionManager().enabled=!0},start:function(){this._isTouch=!1},update:function(e){}}),cc._RF.pop()},{}]},{},["main"]);