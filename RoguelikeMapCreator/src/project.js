window.__require=function t(e,i,n){function o(s,r){if(!i[s]){if(!e[s]){var c=s.split("/");if(c=c[c.length-1],!e[c]){var h="function"==typeof __require&&__require;if(!r&&h)return h(c,!0);if(a)return a(c,!0);throw new Error("Cannot find module '"+s+"'")}}var l=i[s]={exports:{}};e[s][0].call(l.exports,function(t){return o(e[s][1][t]||t)},l,l.exports,t,e,i,n)}return i[s].exports}for(var a="function"==typeof __require&&__require,s=0;s<n.length;s++)o(n[s]);return o}({main:[function(t,e,i){"use strict";cc._RF.push(e,"13201ArYMZBvLvxXK160b4h","main");var n=cc.Enum({FLOOR:0,WALL:1,ITEM:2,ENEMY:3,STAIRS:4}),o=function(){return cc.game.config.debugMode<=1};cc.Class({extends:cc.Component,properties:{floorPrefab:{type:cc.Prefab,default:null},wallPrefab:{type:cc.Prefab,default:null},enemyPrefab:{type:cc.Prefab,default:null},itemPrefab:{type:cc.Prefab,default:null},stairsPrefab:{type:cc.Prefab,default:null},detailPanelPrefab:{type:cc.Prefab,default:null},_isTouch:!1,_fileName:"map",_cannotAction:!1},setStateLabel:function(t){this.node.getChildByName("stateLabel").getComponent(cc.Label).string=t},onTapChangeMoveMode:function(){var t=this;if(!this._cannotAction){this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("move"),this.node.getChildByName("positionResetButton").active=!0;var e=null,i=this.node.getChildByName("map");this.node.on(cc.Node.EventType.TOUCH_START,function(i){t._cannotAction||(t._isTouch=!0,e=i.getLocation())},this),this.node.on(cc.Node.EventType.TOUCH_MOVE,function(n){if(t._isTouch&&e){var o=n.getLocation();i.position=i.position.add(o.sub(e)),e=o}},this);var n=function(i){t._isTouch=!1,e=null};this.node.on(cc.Node.EventType.TOUCH_END,n,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,n,this)}},onTapMoveReset:function(){this.node.targetOff(this),this.subUIDisabled(),this.node.getChildByName("map").position=cc.v2(0,0)},getNearlyPosition:function(t,e){var i=t.x%e,n=t.y%e,o=(Math.trunc(t.x/e)+(i>=e/2?1:i<-e/2?-1:0))*e,a=(Math.trunc(t.y/e)+(n>=e/2?1:n<-e/2?-1:0))*e;return new cc.Vec2(o,a)},isAlreadyPutObject:function(t,e){for(var i=this.node.getChildByName("map").getChildren().filter(function(t){return t.type==e}),n=0;n<i.length;n++)if(i[n].x==t.x&&i[n].y==t.y)return!0;return!1},generateFloor:function(t){var e=this.node.getChildByName("map"),i=this.getNearlyPosition(e.convertToNodeSpace(t),50);if(!this.isAlreadyPutObject(i,n.FLOOR)){var o=cc.instantiate(this.floorPrefab);o.type=n.FLOOR,o.position=i,e.addChild(o)}},onTapChangeFloorMode:function(){var t=this;if(!this._cannotAction){this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("floor"),this.node.on(cc.Node.EventType.TOUCH_START,function(e){t._cannotAction||(t._isTouch=!0,t.generateFloor(e.getLocation()))},this),this.node.on(cc.Node.EventType.TOUCH_MOVE,function(e){t._isTouch&&t.generateFloor(e.getLocation())},this);var e=function(e){t._isTouch=!1,t.save()};this.node.on(cc.Node.EventType.TOUCH_END,e,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,e,this)}},getfloor:function(t){for(var e=this.node.getChildByName("map").getChildren().filter(function(t){return t.type==n.FLOOR}),i=0;i<e.length;i++)if(e[i].x==t.x&&e[i].y==t.y)return e[i];return null},getWallPositionAndAngle:function(t,e){var i=180*Math.atan2(t.x-e.x,t.y-e.y)/Math.PI,n=cc.v2(0,0),o=0;return i>-45&&i<=45?(n=cc.v2(0,25),o=0):i>45&&i<=135?(n=cc.v2(25,0),o=-90):i>-135&&i<=-45?(n=cc.v2(-25,0),o=90):(n=cc.v2(0,-25),o=180),{position:e.add(n),angle:o}},generateWall:function(t){var e=this.node.getChildByName("map"),i=e.convertToNodeSpace(t),o=this.getNearlyPosition(i,50);if(this.getfloor(o)){var a=this.getWallPositionAndAngle(i,o);if(!this.isAlreadyPutObject(a.position,n.WALL)){var s=cc.instantiate(this.wallPrefab);s.type=n.WALL,s.position=a.position,s.angle=a.angle,e.addChild(s)}}},onTapChangeWallMode:function(){var t=this;if(!this._cannotAction){this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("wall"),this.node.on(cc.Node.EventType.TOUCH_START,function(e){t._cannotAction||(t._isTouch=!0,t.generateWall(e.getLocation()))},this),this.node.on(cc.Node.EventType.TOUCH_MOVE,function(e){t._isTouch&&t.generateWall(e.getLocation())},this);var e=function(e){t._isTouch=!1,t.save()};this.node.on(cc.Node.EventType.TOUCH_END,e,this),this.node.on(cc.Node.EventType.TOUCH_CANCEL,e,this)}},isAlreadyPutEnemy:function(t){return t.getChildren().filter(function(t){return t.type==n.ENEMY}).length>0},generateEnemy:function(t){var e=this.node.getChildByName("map").convertToNodeSpace(t),i=this.getNearlyPosition(e,50),o=this.getfloor(i);if(o&&!this.isAlreadyPutEnemy(o)&&!this.isAlreadyPutStairs(o)){var a=cc.instantiate(this.enemyPrefab);a.type=n.ENEMY,a.position=cc.v2(0,0),this.isAlreadyPutItem(o)&&a.setContentSize(10,10),o.addChild(a),this.showDetailView(o)}},onTapChangeEnemyMode:function(){var t=this;this._cannotAction||(this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("enemy"),this.node.on(cc.Node.EventType.TOUCH_START,function(e){t._cannotAction||(t._isTouch=!0,t.generateEnemy(e.getLocation()))},this))},isAlreadyPutItem:function(t){return t.getChildren().filter(function(t){return t.type==n.ITEM}).length>0},generateItem:function(t){var e=this.node.getChildByName("map").convertToNodeSpace(t),i=this.getNearlyPosition(e,50),o=this.getfloor(i);if(o&&!this.isAlreadyPutItem(o)&&!this.isAlreadyPutStairs(o)){var a=cc.instantiate(this.itemPrefab);a.type=n.ITEM,a.position=cc.v2(0,0),this.isAlreadyPutEnemy(o)&&a.setContentSize(10,10),o.addChild(a),this.showDetailView(o)}},onTapChangeItemMode:function(){var t=this;this._cannotAction||(this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("item"),this.node.on(cc.Node.EventType.TOUCH_START,function(e){t._cannotAction||t.generateItem(e.getLocation())},this))},isAlreadyPutStairs:function(t){return t.getChildren().filter(function(t){return t.type==n.STAIRS}).length>0},generateStairs:function(t){var e=this.node.getChildByName("map").convertToNodeSpace(t),i=this.getNearlyPosition(e,50),o=this.getfloor(i);if(o&&!(this.isAlreadyPutStairs(o)||this.isAlreadyPutItem(o)||this.isAlreadyPutEnemy(o))){var a=cc.instantiate(this.stairsPrefab);a.type=n.STAIRS,a.position=cc.v2(0,0),o.addChild(a),this.showDetailView(o)}},onTapChangeStairsMode:function(){var t=this;this._cannotAction||(this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("stairs"),this.node.on(cc.Node.EventType.TOUCH_START,function(e){t._cannotAction||t.generateStairs(e.getLocation())},this))},convertJson:function(){var t=this.node.getChildByName("map").getChildren().map(function t(e){return{id:e.interId,type:e.type,position:e.position,angle:e.angle,children:e.getChildren().map(t)}});return JSON.stringify(t)},onTapDownload:function(){if(!this._cannotAction){this.save();var t=this.convertJson();o()||(t=Base64.toBase64(RawDeflate.deflate(Base64.utob(t))));var e=this.node.getChildByName("saveWindow");e.active=!0,e.getComponent(cc.WebView).url="https://viviria.github.io/JsonDownloader/?name="+this._fileName+"&data="+t}},subUIDisabled:function(){this.node.getChildByName("saveWindow").active=!1,this.node.getChildByName("positionResetButton").active=!1,this.closeDetailView()},getHitWall:function(t){for(var e=this.node.getChildByName("map").getChildren().filter(function(t){return t.type==n.WALL}),i=0;i<e.length;i++){var o=e[i].getComponent(cc.BoxCollider).world.points;if(cc.Intersection.pointInPolygon(t,o))return e[i]}return null},removeObject:function(t){var e=this.getHitWall(t);if(e)e.removeFromParent();else{var i=this.node.getChildByName("map").convertToNodeSpace(t),n=this.getNearlyPosition(i,50),o=this.getfloor(n);if(o){var a=o.getChildren().reverse();if(a.length>0)return a[0].removeFromParent(),void this.save();o.removeFromParent(),this.save()}}},onTapChangeRemoveMode:function(){var t=this;this._cannotAction||(this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("remove"),this.node.on(cc.Node.EventType.TOUCH_START,function(e){t._cannotAction||t.removeObject(e.getLocation())},this))},showDetailFloor:function(t){var e=this.node.getChildByName("map").convertToNodeSpace(t),i=this.getNearlyPosition(e,50),n=this.getfloor(i);n&&this.showDetailView(n,!1)},onTapChangeDetailMode:function(){var t=this;this._cannotAction||(this.node.targetOff(this),this.subUIDisabled(),this.setStateLabel("detail"),this.node.on(cc.Node.EventType.TOUCH_START,function(e){t._cannotAction||t.showDetailFloor(e.getLocation())},this))},save:function(){var t=this.convertJson();t&&"[]"!=t&&(o()||(t=Base64.toBase64(RawDeflate.deflate(Base64.utob(t)))),cc.sys.localStorage.setItem(this._fileName,t))},getPrefabByType:function(t){switch(t){case n.FLOOR:return this.floorPrefab;case n.WALL:return this.wallPrefab;case n.ENEMY:return this.enemyPrefab;case n.ITEM:return this.itemPrefab;case n.STAIRS:return this.stairsPrefab}return null},convertMap:function(t){var e=this,i=function(t,e){for(var i=0;i<e.length;i++)if(t.addChild(e[i]),e[i].type!=n.FLOOR&&e[i].type!=n.WALL){var o=e[i].getContentSize();e[i].setContentSize(o.width*Math.pow(.5,i),o.height*Math.pow(.5,i))}},a=this.node.getChildByName("map"),s=t;if(o()||(s=Base64.btou(RawDeflate.inflate(Base64.fromBase64(s)))),s&&"[]"!=s){var r=JSON.parse(s).map(function t(n){var o=e.getPrefabByType(n.type),a=cc.instantiate(o);a.interId=n.id,a.type=n.type,a.position=n.position,a.angle=n.angle;var s=n.children.map(t);return i(a,s),a});i(a,r)}},onTapStartOk:function(){var t=this.node.getChildByName("startMenu"),e=t.getChildByName("editBox").getComponent(cc.EditBox);if(this._fileName=e.string||"map",this._fileName){var i=cc.sys.localStorage.getItem(this._fileName);i&&this.convertMap(i)}t.active=!1;var n=this.node.getChildByName("ui");n.active=!0,n.getChildByName("mapNameLabel").getComponent(cc.Label).string=this._fileName},setUIButtonEnabled:function(t){for(var e=this.node.getChildByName("ui").getChildren(),i=0;i<e.length;i++){var n=e[i].getComponent(cc.Button);n&&(n.interactable=t)}},createDetailPanel:function(t){var e=cc.instantiate(this.detailPanelPrefab),i=this.getPrefabByType(t.type),o=cc.instantiate(i);o.position=cc.v2(0,0),e.getChildByName("type").addChild(o),e.getChildByName("nameLabel").getComponent(cc.Label).string=i.data.name,e.targetNode=t;var a=e.getChildByName("id");return e.getChildByName("id").getChildByName("idEditBox").getComponent(cc.EditBox).string=void 0===t.interId?-1:t.interId,a.active=t.type!=n.FLOOR,e},showDetailView:function(t){var e=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=t.getChildren();if(!(i.length<=0)){var n=this.node.getChildByName("mark");n.active=!0,n.position=t.position.add(t.parent.position);var o=this.node.getChildByName("detailView");o.active=!0;var a=o.getComponent(cc.ScrollView).content;a.removeAllChildren();var s=this.createDetailPanel(t);s.position=cc.v2(0,-20),a.addChild(s);for(var r=0;r<i.length;r++)(s=this.createDetailPanel(i[r])).position=cc.v2(0,-r*(s.height+10)-20),a.addChild(s);e&&(this.node.getChildByName("viewBackground").active=!0,this.setUIButtonEnabled(!1),this._cannotAction=!0)}},onTapDetailSave:function(){for(var t=this.node.getChildByName("detailView").getComponent(cc.ScrollView).content.getChildren(),e=0;e<t.length;e++){var i=t[e],n=i.getChildByName("id").getChildByName("idEditBox");i.targetNode.interId=Number(n.getComponent(cc.EditBox).string)}this.save(),this.closeDetailView()},closeDetailView:function(){this.node.getChildByName("detailView").active=!1,this.node.getChildByName("mark").active=!1,this._cannotAction&&(this._cannotAction=!1,this.setUIButtonEnabled(!0),this.node.getChildByName("viewBackground").active=!1)},onTapSpecialView:function(){var t=this.node.getChildByName("specialView");this.setUIButtonEnabled(!1),this.node.getChildByName("viewBackground").active=!0,t.active=!0,this._cannotAction=!0},onTapCloseSpecialView:function(){var t=this.node.getChildByName("specialView");this.setUIButtonEnabled(!0),this.node.getChildByName("viewBackground").active=!1,t.active=!1,this._cannotAction=!1},onTapRemoveMap:function(){cc.sys.localStorage.removeItem(this._fileName),this.node.getChildByName("map").removeAllChildren(),this.onTapCloseSpecialView()},onLoad:function(){cc.director.getCollisionManager().enabled=!0},start:function(){this._isTouch=!1},update:function(t){}}),cc._RF.pop()},{}]},{},["main"]);